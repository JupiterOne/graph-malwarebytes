import {
  Recording,
  RecordingEntry,
  setupRecording,
  SetupRecordingInput,
} from '@jupiterone/integration-sdk-testing';
import isJson from '../../src/utils/isJson';

export function setupMalwareBytesRecording(
  input: Omit<SetupRecordingInput, 'mutateEntry'>,
): Recording {
  return setupRecording({
    ...input,
    mutateEntry: mutateRecordingEntry,
  });
}

export function mutateRecordingEntry(entry: RecordingEntry): void {
  const responseText = entry.response.content.text;
  if (!responseText) {
    return;
  }

  // Redact access_token being visible in response for /oauth2/token endpoint
  if (entry.request.url.includes('/oauth2/token') && entry.request.postData) {
    if (isJson(responseText)) {
      const responseJson = JSON.parse(responseText);
      entry.response.content.text = JSON.stringify(
        {
          ...responseJson,
          access_token: '[REDACTED]',
        },
        null,
        0,
      );
    }
  }

  // Redact sensitive information
  if (
    entry.request.url.includes('nebula/v1/endpoints') &&
    entry.request.postData
  ) {
    if (isJson(responseText)) {
      const responseJson = JSON.parse(responseText);

      for (const endpoint of responseJson.endpoints) {
        endpoint.agent.nics = 'REDACTED';
        endpoint.agent.source_location = 'REDACTED';
        endpoint.agent.machine_ip = 'REDACTED';
      }

      entry.response.content.text = JSON.stringify(responseJson, null, 0);
    }
  }
}
