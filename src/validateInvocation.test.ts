import {
  IntegrationProviderAuthenticationError,
  IntegrationValidationError,
} from '@jupiterone/integration-sdk-core';
import {
  createMockExecutionContext,
  setupRecording,
} from '@jupiterone/integration-sdk-testing';

import { CalculatedIntegrationConfig } from './types';
import validateInvocation from './validateInvocation';

it('requires valid config', async () => {
  const executionContext = createMockExecutionContext<
    CalculatedIntegrationConfig
  >({
    instanceConfig: {} as CalculatedIntegrationConfig,
  });

  try {
    await validateInvocation(executionContext);
  } catch (e) {
    expect(e instanceof IntegrationValidationError).toBe(true);
  }
});

it('auth error', async () => {
  const recording = setupRecording({
    directory: '__recordings__',
    name: 'client-auth-error',
  });

  recording.server.any().intercept((req, res) => {
    res.status(401);
  });

  const executionContext = createMockExecutionContext<
    CalculatedIntegrationConfig
  >({
    instanceConfig: {
      accountId: 'INVALID',
      clientId: 'INVALID',
      clientSecret: 'INVALID',
      minScannedSinceDays: 30,
      minFindingsSinceDays: 30,
      minFindingsSinceISODate: '2020-10-12T18:43:44Z',
      maxFindingsSinceISODate: '2020-10-12T18:43:44Z',
      minScannedSinceISODate: '2020-10-12T18:43:44Z',
      maxScannedSinceISODate: '2020-10-12T18:43:44Z',
    },
  });

  try {
    await validateInvocation(executionContext);
  } catch (e) {
    expect(e instanceof IntegrationProviderAuthenticationError).toBe(true);
  }
});
